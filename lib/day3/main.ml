open! Base
open! Stdio

(*
--- Day 3: Gear Ratios ---
You and the Elf eventually reach a gondola lift station; he says the gondola lift will take you up to the water source, but this is as far as he can bring you. You go inside.

It doesn't take long to find the gondolas, but there seems to be a problem: they're not moving.

"Aaah!"

You turn around to see a slightly-greasy Elf with a wrench and a look of surprise. "Sorry, I wasn't expecting anyone! The gondola lift isn't working right now; it'll still be a while before I can fix it." You offer to help.

The engineer explains that an engine part seems to be missing from the engine, but nobody can figure out which one. If you can add up all the part numbers in the engine schematic, it should be easy to work out which part is missing.

The engine schematic (your puzzle input) consists of a visual representation of the engine. There are lots of numbers and symbols you don't really understand, but apparently any number adjacent to a symbol, even diagonally, is a "part number" and should be included in your sum. (Periods (.) do not count as a symbol.)

Here is an example engine schematic:

467..114..
...*......
..35..633.
......#...
617*......
.....+.58.
..592.....
......755.
...$.*....
.664.598..
In this schematic, two numbers are not part numbers because they are not adjacent to a symbol: 114 (top right) and 58 (middle right). Every other number is adjacent to a symbol and so is a part number; their sum is 4361.

Of course, the actual engine schematic is much larger. What is the sum of all of the part numbers in the engine schematic?   
*)

let example_engine_schematic =
  {|467..114..
...*......
..35..633.
......#...
617*......
.....+.58.
..592.....
......755.
...$.*....
.664.598..|}

type value = {value : int; min_x : int}

let is_adjacent_to_symbol ~n ~m ~min_x ~max_x ~y ~is_symbol : bool =
  let exception IsAdjacent in
  try
    for i = Int.max 0 (y - 1) to Int.min (n - 1) (y + 1) do
      for j = Int.max 0 (min_x - 1) to Int.min (m - 1) (max_x + 1) do
        if is_symbol.(i).(j) then raise IsAdjacent
      done
    done;
    false
  with IsAdjacent -> true

let process (schematic : string) =
  schematic
  |> String.split_lines
  |> Array.of_list
  |> function
  | [||] -> 0
  | lines ->
    let n = Array.length lines in
    let m = String.length lines.(0) in
    let is_symbol =
      Array.init n ~f:(fun y ->
          Array.init m ~f:(fun x ->
              let char = String.get lines.(y) x in
              (not (Char.is_digit char)) && not (Char.equal '.' char)
          )
      )
    in
    let sum = ref 0 in
    let add_num value ~min_x ~max_x ~y : unit =
      if is_adjacent_to_symbol ~n ~m ~min_x ~max_x ~y ~is_symbol then (
        printf "adding %d\n" value;
        sum := !sum + value
      )
      else printf "not adding %d\n" value
    in
    Array.iteri lines ~f:(fun y line ->
        String.foldi line ~init:None ~f:(fun x num char ->
            match num, Int.of_string_opt (String.of_char char) with
            | Some num, Some next_digit ->
              Some {num with value = (num.value * 10) + next_digit}
            | Some {value; min_x}, None ->
              add_num value ~min_x ~max_x:(x - 1) ~y;
              None
            | None, Some value -> Some {value; min_x = x}
            | None, None -> None
        )
        |> function
        | None -> ()
        | Some {value; min_x} -> add_num value ~min_x ~max_x:m ~y
    );
    !sum

let%expect_test _ =
  example_engine_schematic |> process |> printf "Final value: %d\n";
  [%expect
    {|
    adding 467
    not adding 114
    adding 35
    adding 633
    adding 617
    not adding 58
    adding 592
    adding 755
    adding 664
    adding 598
    Final value: 4361 |}]

let puzzle_input =
  {|.....613...................................439............498.........................438......617....343.............942...................
.......*............790...........269..735..*........................../679..............*444.*.........*.......147...*.............441.....
....539......422.......*......662*........*..691..........*124.15..675.................=.......404...872............237......930.....+......
........334.............861.........%....479..........424.......+.@.......402.......314...905................833........*293................
..........#.......................906.................*...............950.....................712...437.........*142.359........551.14......
....509.....=...........890...................&........9................./..847.154..568............@...102................280...*..........
.....*..950.67.............-......161.......530....=...................=............*...../..............@.......................426........
614...............................*.............59.591.....259*.......342...427..........29../.........-....................946.............
.......896........808..............6.............*.............35............./......538.....572....510...677*380...........=...............
.......*.............*534..814................879...............................615/....*............................90.........580...413...
.......810..........................................714.260..498..........386..........877......754........793...943.*............/.....*...
.....................845..#..483........55...643.......*......&.....421..+.....+...527.....938............*.......*...993...............706.
....339*..370..........-.540.@.....337..........*........39........*........404......&.......*...483...308.....567................../.......
..........*......994..............*......855..356.768.....*.....114...@195..................976....-...............496.61...610...369.200...
..........15........*...@890...447.........*.........*.303......................821..251*....................8........*....+................
...962.............260...................@..716....893..............304............*.....537.........805.....#..........................388.
............201*........................281.............471........*...../.....=....959...............%..238....180..641@...................
....278.........132..........65...&.........*920.......*.......831..97..828.....533......#368............../.......*......66-...............
.....*................*......*..627......343..........111.....*.....................................*.100$........693..........780..........
...974........474..537.759.101.......366....................183...............461*178..850.......644.........57.............................
..........67$.@.........................*...879..................54.100..355.................794.............=.....................826.530..
494*549...............670...=194.....173............329=....*14....*........*....811*303....*....891..541........975........................
........................*................403.............591................667............630....*.....$.667*....#...*......819.........19.
572...@.......%.......271..........910.........578.551..........818.534...........................217.........809.....262.....+.............
.....105.......748..............%........637...*...*........515....*...................119............*143..@.....258.......................
.20........115........714....525...491....*..768...647.....*...................433..../............583.......404..#..............268........
.......650..*.....%......%............*.311............275.283.306..=659.....................499........@................652.176............
..100.....#.193.637..........828...806.............725*........*..............................@......418........370.......@........86&..977.
......350................229..$.............................%...724.....#.981*582..$...............................*.38.....38.503......$...
.......#..380...........*.............311........%..........968......647..........33..................634*13......72./...%...*..*...........
............*.203*52.......+........./...........295.....................888..........277...938..662.........3.........619.320...766........
....149...883..............817...........163............959..........8.....*.811%............*......&...354..+.....392......................
....................727........789......*...............@...............739.........537....326.............*......*.......&925.........938..
..383..505.166......-.........*.......565......491........136.....693..........870.%...........#...........654..&..313.................*....
.........=..$..801....962.....787..........181......186.../..........*103........+............826....599.......289.....311.768..........986.
.292.414..........*......*................*..................214.....................439.@130...........+...52........*.....*.....989*......
.........221......149....405...@...........393..........714.....&.......652............*............607....*.........412....682.......982...
.........*......................491.......................*..............-......906..909.......885.....%.747......19........................
......567.........193........1..................925.........78......117.....797*................@............208............................
.............943..*.....571...*.....919.487............/....+.........*.......................................*......433.922.......795......
....66......*....92..........367.......*....883.625.....479....852@.............277.635............860.......940..21....*....995.....&......
.........206............595%...................*............./.......................*......691.......*..........*..........*...............
.....766.............&................=...........*...649-.241...56..@724..713..836.863.......=....676...+..824.506......247..$132..........
.....................278..........917..864.....219...............+............%.*......................973.........................744......
.........912...............%......*................979....-953...................733.............&................................*.........
.........@........$........995....905......552...................391.........40=.......388.......141...................731*640.....511......
123..662...989.672............................*........611......+.....%910.............*....5......................584......................
...*...*../...........................306.....289.*....*.............................673.....*........970..51....@....*...............#.....
...916.23.......14..828........908.................181.227......26....190.....723..*.......877...513...@...*..977......319..867/...997..76..
..........158........=............$..............................%............#...605....................264.......569.....................1
.....453..*............................815.430*........946..840.........................456.........152................23...................
216.....*.389...........930............*.......211.......-...*.....635..472*185.................................@444...*.....783...966......
...*...72.................*..........527...+...............636.......*.............746....575.....5...276.821........568.+......*...-.......
..765...........991........686..142*......588......@...........366....395.............*..*...............................983...266..........
.................+..................383.............330..&......%...............337.853.337........927.@703.&513......................855...
...652................=../..@.............431....48......512...............541....%.................+.............-...835/.......%......*...
.....*..205.....510.92..901.778............*......./............588.........#..........@....................968.603........820...75....844..
...560............/........................597...................&.......#............698..........427........*...../249....................
..............817..........50..........208..................149..........169........................*......835..............522.............
.....-......................*............*.....470......%..*.......151.................731.......395..979.........200.........#.......$.....
..242.........698........763............531.....*....252...533.....*.........64.........*...233.........*............*262.............498...
........994.....*...............620.639......575................934..606.99....*....770.72.#......@.............................-...........
.......*.........658..355.........#...*............*...*597..............*...645......*........292........-..354...@.......409...515........
........453..594.......#..............571..=552.193...8.............820...69.........877....%..........846.....*...525.446....*........*386.
....&...........#..................................................*....-.................652.................500............361....290.....
...833..................652.....410..924*72..........*.../104.....231.223....@...%....775................375................................
.................470...........*..................663.......................179.10....&.........256..770*............243.........354........
...*5.............*............962......-....................../.....529...................../.....*.........39.255./.......73......&.......
...............253..766....$.............659........$497..241.656....&....630................262.212...154.......*............*.............
...................*....755...................375...........*................@...........................*.....936...159.......786...981....
...................78....................426.....*39....885..835....432..............439.................335............@...................
.......*574.785............................................*................736......*.....860....395...........381...........@..114...825..
....557........@.............187.....640......514.36*.....834.........630...@....*..194......#....-......*......*....164....440.%.....*.....
...................744.908....*........*......*......185......................165........635..........464.354..104.................996......
.........................*.805..604..375...326........................*.................../....970.....................*....................
....751.....776.......661.......*.................777*........434..952.662....2......................$.923...........99.463.........&.514...
....*........*.....55..........414..............................*..............$......&522........378............+............*....89..*....
.331.......403..94..................547.551..............300...600........=......452.......976.+...............213.........815.757..........
.....209-......*...760...............@...*.............................963........+..........*.906.......785...........................+....
958...........319....@.....+.334..........640.................................798.........611......678.....*..630.......389............426..
.........../............961..*..................608..472...........45...........*...................*....390.............*..................
.....597..191......&861.......279.689.............=....*.972*..........560......900.............548..97.......240...51....2....411.......233
......*.......379.................*......+...........770.....989...955...&.214#.........*588.......*.............%..$.......................
....982.&.......................82....850...450......................*...............755.....799....539.....298.........993........788......
.........901....382.......569...............&........428............281.....=599.........98.../....................789.@......956.=....450..
.................*..497/..*...664....*...............%.........610................/944.....*....778......713*375.....*.................*....
.......@......637........443.../...905............................*883.......389...........563......................388...$.....*559....386.
........241.......*597.........................876..............$........731*.....192.483..............#958...%..*......828..100............
...89&.........994.........*228...............#...........18...413..............1....*...........*..........157...453.......................
..........573...........198............447........488.672../.#......&383.........%.....589........511..................46...................
.....*449......$...228*................+.............*........662.........%.............*....321........34%....838&...*.....................
..592.......659...............=...........................................188..248....836......*....................141..%......344.........
............................564....481..............-..........................................861............%...........93.....$...$.936..
..........618.287......490$.......-............*..304.........662.........@....196...@...72*.........918.339.999.-.................28.......
.............*..............................556.......812.272.....235@.510...#.....51.......804...........#.......209......323=.............
.../471..474.................446.......*........855....*....#..............265..................588.24.......522............................
............*........86..755..+........664........*.....311........793.361.....685.......859..../...@..158......=...667#...........871......
...........529.........&.*.........................624........578....*...................*..................334..........843................
....32#........12..818...406......888.........555........678...*...................@....796.%........159.......-.......$.......@142..289....
..........797..@...*..........246....*..........*.............473............485..683.......526.......*................987...........*......
...272....-.......763...........*...............546....203......................%..................560.....294........................921...
......+...............439...144..909....221...............*245.............847....971..........812............*.............................
...........66....+.........*.........20......337.....591.......*.226.&.....*.......-..+113........./........321..756...518....*.............
......325......166..........848................*.267*........857..*..34.....471.............579+.851...322........#...*........125..........
.........*..........157......................77..................567....646...........................*......783....634.5....@..............
.598.497.275.......&......908=............................................$.......172*324...$263.....207......&.........@...340...160....80.
....*..................#........484..833.998....*.....#.......945.135.......108..................104........................................
..............908....645..264*..........*....581.332...519.......*.........*...........811..................214&..$............57...........
....%543.......@..............807..768.......................23............578.........&.....545...................988........*.........#...
...........547..........&.818........*................669....*........395.........88........*.....964*.....................230..105....471..
......................231.&.........645....*982..398...@.....442..........................311.........466....168..788..474......-...........
..233......638.254......................824..........%...........676.....413......818.............................*.......*.................
..............*.........672.137..............866...862...376........*.........933*............455.................158....682..180*333.......
........454$...........*.......................*........#.............................../18.....*.....677...664.........................%867
..............318....107...........*793.....361...............................*................372.......*.....*509......765.203....737.....
.................%........*.216.831....................509.....392............508...........&...........780.........219.....*......&....*635
334............&........862................945.....162*.........*.......529.......164.......627.381*........591........*83...........155....
.......278...476....363....../.........785.%................431...........*..........*529...........194......*..............982*91..........
.......*..................994..480.....*......*.......236...*........825.450......&.......&..797*.......634.249.......................626...
408.699........*527............*....900....145.880...*......833......*...........456....914......432...*...............391..537........*....
.........................836..955.....................126............557.............................870...38..........*.....*.......388....
.................+275.......*..................=................/............526..................................-....66....587............
..........................400....&............933.......*.....535........455*.....&...209.699........90....*10..207...............*.67......
..............757................719.-............*..-...38.....................22.....*..+...254.....$.736..................201.80.+.......
.....86.584............+..*..........531........335.949.......500...........544.....22.11....*......%.........774*434...337...........331...
.183...*............553....691..131..........................*.................*..............186..591..=171............................*...
...*..........645........*.........*.......365............654......*........843..649.............................673.....867........#.218...
....533..206..*...528=...618........891.41*......................988.596........$......%......391..506..672...../...........*103..926.......
............$.49..............*.....................445................@..../......&..678...................61..............................
..63.............998.......927...295..600....303..........352..............358...464......234.......-.......*....517.......-778....32..641..
....*693............*..............*...*...+.../..70......@...417......*.......$.........*..........417...940.....@....................*....
.................529...561.......706...894.740.......117=....+.......251....642...&763..183..................................$..............
544.651.......+........*....951..................438............505..................................309......800..........534..............
...*...........864.....930....*...36*.......418....*...............*................703...............*.........%..431................=.....
...........463................73.....476............942...55.....127..........................560..959................*.............255.....
......%...*.......176..969#...............@35...............*........-.........242...............=.........147.......914....191.............
....71....686................*.................260.........62.423...823..............-.....................*...................=.186........
.................521..447....940...123........*.................+..........62....855..452...............455.......264....9..........*165....
.......$608..675*.....*.../.......*............72......../...........*484....*....=................................*......*.....%...........
...................302..476.......64.....................159......815......445..........965........................558...824....281......98.|}

let%expect_test _ =
  puzzle_input |> process |> printf "Final value: %d\n";
  [%expect
    {|
    adding 613
    adding 439
    not adding 498
    adding 438
    adding 617
    adding 343
    adding 942
    adding 790
    adding 269
    adding 735
    adding 679
    adding 444
    not adding 147
    adding 441
    adding 539
    not adding 422
    adding 662
    adding 691
    adding 124
    adding 15
    adding 675
    adding 404
    adding 872
    adding 237
    not adding 930
    adding 334
    adding 861
    adding 479
    adding 424
    not adding 402
    adding 314
    not adding 905
    adding 833
    adding 293
    adding 906
    adding 950
    not adding 712
    adding 437
    adding 142
    adding 359
    adding 551
    not adding 14
    adding 509
    adding 890
    adding 9
    not adding 847
    not adding 154
    adding 568
    adding 102
    not adding 280
    not adding 950
    adding 67
    adding 161
    adding 530
    adding 426
    not adding 614
    adding 59
    adding 591
    adding 259
    adding 342
    adding 427
    adding 29
    adding 946
    adding 896
    adding 808
    adding 6
    adding 35
    adding 538
    adding 572
    adding 510
    adding 677
    adding 380
    adding 534
    not adding 814
    adding 879
    adding 615
    adding 90
    adding 580
    adding 413
    adding 810
    adding 714
    adding 260
    adding 498
    adding 386
    adding 877
    not adding 754
    adding 793
    adding 943
    adding 845
    adding 483
    not adding 55
    adding 643
    adding 421
    adding 527
    adding 938
    adding 993
    adding 706
    adding 339
    adding 370
    adding 540
    adding 337
    adding 39
    adding 404
    adding 483
    adding 308
    adding 567
    adding 994
    adding 855
    adding 356
    adding 768
    adding 114
    adding 195
    adding 976
    adding 496
    adding 61
    adding 610
    adding 369
    not adding 200
    adding 15
    adding 890
    adding 447
    adding 303
    adding 821
    adding 251
    adding 8
    not adding 962
    adding 260
    adding 716
    adding 893
    adding 304
    adding 537
    adding 805
    not adding 388
    adding 201
    adding 281
    adding 471
    adding 959
    adding 238
    adding 180
    adding 641
    adding 278
    adding 132
    adding 65
    adding 920
    adding 831
    adding 97
    adding 828
    adding 533
    adding 368
    adding 66
    adding 627
    adding 343
    adding 111
    adding 100
    adding 693
    not adding 780
    adding 974
    adding 474
    adding 537
    adding 759
    adding 101
    adding 366
    adding 183
    adding 461
    adding 178
    not adding 850
    adding 644
    adding 57
    adding 67
    not adding 879
    adding 54
    adding 100
    adding 355
    adding 794
    not adding 826
    not adding 530
    adding 494
    adding 549
    adding 670
    adding 194
    adding 173
    adding 329
    adding 14
    adding 811
    adding 303
    adding 891
    adding 541
    adding 975
    not adding 403
    adding 591
    adding 667
    adding 630
    adding 667
    adding 819
    not adding 19
    not adding 572
    adding 271
    not adding 910
    adding 578
    adding 551
    adding 818
    adding 534
    adding 217
    adding 809
    adding 262
    adding 105
    adding 748
    adding 637
    adding 515
    adding 119
    adding 143
    adding 258
    not adding 20
    adding 115
    adding 714
    adding 525
    adding 491
    adding 768
    adding 647
    not adding 433
    adding 583
    adding 404
    not adding 268
    adding 650
    adding 311
    adding 275
    adding 283
    adding 306
    adding 659
    adding 499
    adding 652
    not adding 176
    not adding 100
    adding 193
    adding 637
    adding 828
    adding 806
    adding 725
    adding 418
    adding 370
    adding 86
    adding 977
    adding 350
    adding 229
    adding 724
    adding 981
    adding 582
    adding 38
    adding 38
    adding 503
    adding 380
    adding 311
    adding 968
    adding 647
    adding 33
    adding 634
    adding 13
    adding 72
    adding 203
    adding 52
    adding 295
    adding 888
    not adding 277
    adding 938
    adding 662
    adding 3
    adding 619
    adding 320
    adding 766
    not adding 149
    adding 883
    adding 817
    adding 163
    adding 959
    not adding 8
    adding 811
    adding 354
    adding 392
    adding 727
    adding 789
    adding 739
    adding 537
    adding 326
    adding 925
    adding 938
    not adding 383
    adding 505
    adding 166
    adding 565
    not adding 491
    adding 136
    adding 693
    adding 870
    adding 654
    adding 313
    adding 801
    adding 962
    adding 787
    adding 181
    not adding 186
    adding 103
    adding 826
    adding 599
    adding 289
    adding 311
    adding 768
    adding 986
    not adding 292
    not adding 414
    adding 214
    adding 439
    adding 130
    adding 52
    adding 989
    adding 221
    adding 149
    adding 405
    adding 393
    adding 714
    adding 652
    adding 607
    adding 412
    adding 682
    adding 982
    adding 491
    adding 906
    adding 909
    adding 885
    adding 747
    not adding 19
    adding 567
    adding 193
    adding 1
    not adding 925
    adding 78
    adding 117
    adding 797
    adding 208
    adding 943
    not adding 571
    adding 919
    adding 487
    adding 433
    adding 922
    adding 795
    not adding 66
    adding 92
    adding 367
    adding 883
    adding 625
    adding 479
    adding 852
    not adding 277
    adding 635
    adding 860
    adding 940
    adding 21
    adding 995
    adding 206
    adding 595
    adding 691
    not adding 766
    adding 649
    adding 241
    adding 56
    adding 724
    adding 713
    adding 836
    adding 863
    adding 676
    not adding 824
    adding 506
    adding 247
    adding 132
    adding 278
    adding 917
    adding 864
    adding 219
    adding 973
    adding 744
    adding 912
    not adding 979
    adding 953
    adding 733
    adding 995
    adding 905
    adding 552
    adding 391
    adding 40
    adding 388
    adding 141
    adding 731
    adding 640
    adding 511
    adding 123
    adding 662
    adding 989
    adding 672
    adding 611
    adding 910
    adding 5
    adding 584
    not adding 306
    adding 289
    adding 673
    adding 970
    adding 51
    adding 916
    adding 23
    not adding 14
    adding 828
    adding 908
    adding 181
    adding 227
    adding 26
    not adding 190
    adding 723
    adding 877
    not adding 513
    adding 977
    adding 319
    adding 867
    adding 997
    not adding 76
    adding 158
    adding 605
    adding 264
    not adding 569
    not adding 1
    adding 453
    adding 815
    adding 430
    adding 946
    adding 840
    not adding 456
    not adding 152
    adding 23
    adding 216
    adding 389
    adding 930
    adding 211
    adding 635
    adding 472
    adding 185
    adding 444
    adding 783
    adding 966
    adding 72
    adding 527
    adding 636
    adding 746
    adding 575
    not adding 5
    not adding 276
    not adding 821
    adding 568
    adding 765
    adding 991
    adding 686
    adding 142
    adding 588
    adding 366
    adding 395
    adding 983
    adding 266
    adding 383
    adding 330
    adding 337
    adding 853
    adding 337
    adding 927
    adding 703
    adding 513
    adding 855
    adding 652
    adding 431
    adding 48
    adding 512
    adding 541
    adding 835
    not adding 205
    adding 510
    adding 92
    adding 901
    adding 778
    adding 588
    adding 968
    adding 603
    not adding 820
    adding 75
    adding 844
    adding 560
    adding 597
    adding 698
    adding 427
    adding 249
    not adding 817
    adding 50
    adding 208
    adding 149
    adding 169
    adding 835
    adding 522
    adding 470
    adding 151
    adding 731
    adding 395
    adding 979
    adding 200
    adding 242
    adding 698
    adding 763
    adding 531
    adding 252
    adding 533
    adding 64
    adding 233
    adding 262
    adding 498
    adding 994
    adding 620
    adding 639
    adding 575
    adding 934
    not adding 606
    adding 99
    adding 770
    adding 72
    adding 658
    adding 355
    adding 597
    adding 645
    adding 292
    adding 354
    adding 409
    adding 515
    adding 453
    adding 594
    adding 571
    adding 552
    adding 193
    adding 8
    adding 820
    adding 69
    adding 877
    adding 846
    adding 525
    not adding 446
    adding 386
    adding 652
    adding 500
    adding 361
    adding 290
    adding 833
    not adding 652
    adding 410
    adding 924
    adding 72
    adding 104
    adding 231
    adding 223
    adding 775
    adding 375
    adding 470
    adding 663
    adding 179
    adding 10
    adding 256
    adding 770
    adding 243
    adding 354
    adding 5
    adding 962
    adding 529
    not adding 39
    adding 255
    adding 73
    adding 253
    adding 766
    adding 659
    adding 497
    adding 241
    adding 656
    adding 630
    adding 262
    adding 212
    adding 154
    adding 755
    adding 375
    adding 936
    adding 159
    adding 786
    not adding 981
    adding 78
    not adding 426
    adding 39
    adding 885
    adding 835
    not adding 432
    adding 439
    adding 335
    adding 574
    adding 785
    adding 736
    adding 860
    adding 395
    adding 381
    adding 114
    adding 825
    adding 557
    adding 187
    adding 640
    adding 514
    adding 36
    adding 834
    not adding 630
    adding 194
    not adding 164
    adding 440
    not adding 744
    adding 908
    adding 185
    adding 165
    adding 635
    adding 464
    adding 354
    adding 104
    adding 996
    adding 805
    adding 604
    adding 375
    adding 326
    not adding 970
    adding 751
    adding 776
    adding 661
    adding 777
    adding 434
    adding 952
    adding 662
    adding 2
    not adding 923
    adding 99
    adding 463
    adding 514
    not adding 55
    adding 414
    adding 522
    adding 378
    adding 89
    adding 331
    adding 403
    adding 94
    adding 547
    adding 551
    not adding 300
    adding 600
    adding 452
    adding 976
    adding 213
    adding 815
    adding 757
    adding 209
    adding 760
    adding 963
    adding 906
    adding 785
    not adding 958
    adding 319
    adding 334
    adding 640
    adding 798
    adding 611
    adding 678
    not adding 630
    adding 389
    adding 426
    adding 961
    adding 608
    adding 472
    not adding 45
    adding 390
    adding 597
    adding 191
    adding 861
    adding 279
    adding 689
    adding 972
    adding 560
    adding 900
    adding 548
    adding 97
    adding 240
    adding 51
    adding 2
    not adding 411
    not adding 233
    not adding 379
    adding 770
    adding 989
    adding 955
    adding 214
    adding 588
    adding 982
    adding 82
    adding 850
    adding 450
    adding 755
    adding 799
    adding 539
    not adding 298
    adding 993
    adding 788
    adding 901
    adding 382
    adding 569
    adding 428
    adding 281
    adding 599
    adding 98
    adding 789
    not adding 956
    adding 450
    adding 497
    adding 664
    adding 610
    adding 944
    not adding 778
    adding 713
    adding 375
    adding 637
    adding 443
    adding 905
    adding 883
    adding 389
    adding 563
    adding 388
    adding 559
    adding 386
    adding 241
    adding 597
    adding 876
    adding 731
    adding 192
    adding 483
    adding 958
    adding 828
    adding 100
    adding 89
    adding 994
    adding 228
    adding 18
    adding 413
    adding 1
    adding 157
    adding 453
    not adding 573
    adding 198
    adding 447
    adding 488
    adding 672
    adding 383
    adding 589
    adding 511
    adding 46
    adding 449
    adding 228
    adding 662
    adding 321
    adding 34
    adding 838
    adding 592
    adding 659
    adding 188
    not adding 248
    adding 836
    adding 141
    adding 344
    adding 564
    adding 481
    adding 861
    adding 93
    not adding 936
    adding 618
    adding 287
    adding 490
    adding 304
    not adding 662
    not adding 196
    adding 72
    not adding 918
    adding 339
    adding 999
    adding 28
    adding 556
    adding 812
    adding 272
    adding 235
    adding 510
    adding 51
    adding 804
    adding 209
    adding 323
    adding 471
    adding 474
    adding 446
    adding 855
    adding 265
    adding 588
    adding 24
    adding 522
    adding 86
    adding 755
    adding 664
    adding 311
    adding 793
    not adding 361
    not adding 685
    adding 859
    not adding 158
    adding 667
    not adding 871
    adding 529
    adding 624
    adding 578
    adding 334
    not adding 843
    adding 32
    adding 12
    adding 818
    adding 406
    adding 888
    adding 555
    not adding 678
    adding 796
    adding 159
    adding 142
    adding 289
    adding 797
    adding 246
    adding 473
    adding 485
    adding 683
    adding 526
    adding 987
    adding 272
    adding 763
    adding 546
    adding 203
    adding 560
    adding 294
    adding 921
    not adding 439
    adding 144
    adding 909
    not adding 221
    adding 245
    adding 847
    adding 971
    not adding 812
    not adding 66
    not adding 20
    adding 337
    adding 591
    adding 226
    adding 113
    adding 321
    adding 756
    adding 518
    adding 325
    adding 166
    adding 848
    adding 267
    adding 857
    adding 34
    adding 471
    adding 579
    adding 851
    adding 322
    adding 125
    adding 157
    adding 77
    adding 567
    adding 646
    adding 783
    adding 634
    adding 5
    adding 598
    adding 497
    adding 275
    adding 908
    adding 172
    adding 324
    adding 263
    adding 207
    adding 340
    not adding 160
    not adding 80
    not adding 484
    adding 833
    adding 998
    adding 945
    adding 135
    adding 108
    not adding 104
    adding 908
    adding 645
    adding 264
    adding 581
    adding 332
    adding 519
    adding 811
    adding 214
    adding 57
    adding 543
    adding 807
    adding 768
    adding 23
    adding 578
    adding 545
    adding 988
    not adding 547
    adding 818
    adding 669
    not adding 395
    not adding 88
    adding 964
    adding 230
    adding 105
    adding 471
    adding 231
    adding 645
    adding 982
    not adding 398
    adding 442
    adding 311
    adding 466
    not adding 168
    adding 788
    adding 474
    not adding 233
    adding 638
    adding 254
    adding 824
    adding 676
    not adding 413
    adding 818
    adding 672
    not adding 137
    adding 866
    adding 862
    adding 376
    adding 933
    adding 455
    adding 158
    adding 682
    adding 180
    adding 333
    adding 454
    adding 18
    adding 677
    adding 664
    adding 867
    adding 318
    adding 107
    adding 793
    adding 361
    adding 372
    adding 509
    adding 765
    adding 203
    adding 737
    not adding 216
    adding 831
    adding 509
    adding 392
    adding 508
    adding 780
    adding 219
    adding 635
    not adding 334
    adding 862
    adding 945
    adding 162
    adding 529
    adding 164
    adding 627
    adding 381
    adding 591
    adding 83
    adding 155
    adding 278
    adding 476
    not adding 363
    adding 785
    adding 431
    adding 529
    adding 194
    adding 982
    adding 91
    adding 994
    adding 480
    adding 236
    adding 825
    adding 450
    adding 797
    adding 634
    adding 249
    adding 626
    not adding 408
    adding 699
    adding 527
    adding 900
    adding 145
    adding 880
    adding 833
    adding 456
    adding 914
    adding 432
    adding 391
    adding 537
    adding 836
    adding 955
    adding 126
    adding 557
    adding 870
    not adding 38
    adding 388
    adding 275
    adding 526
    adding 66
    adding 587
    adding 400
    adding 933
    adding 535
    adding 455
    adding 209
    adding 699
    adding 90
    adding 10
    adding 207
    adding 67
    not adding 757
    adding 719
    adding 38
    adding 22
    adding 254
    adding 736
    not adding 201
    adding 80
    adding 86
    adding 584
    adding 531
    adding 335
    adding 949
    adding 500
    adding 544
    not adding 22
    adding 11
    adding 774
    adding 434
    not adding 337
    adding 331
    adding 183
    adding 553
    adding 691
    adding 131
    adding 186
    adding 591
    adding 171
    adding 645
    adding 365
    adding 654
    adding 843
    adding 649
    adding 673
    adding 867
    adding 218
    adding 533
    adding 206
    adding 528
    adding 618
    adding 891
    adding 41
    adding 988
    adding 596
    not adding 391
    not adding 506
    not adding 672
    adding 103
    adding 926
    adding 49
    not adding 445
    adding 678
    adding 61
    adding 63
    adding 998
    adding 927
    adding 295
    adding 600
    adding 303
    adding 352
    adding 358
    adding 464
    adding 234
    adding 517
    adding 778
    not adding 32
    adding 641
    adding 693
    not adding 70
    adding 417
    adding 417
    adding 940
    adding 529
    adding 561
    adding 706
    adding 894
    adding 740
    adding 117
    adding 251
    adding 642
    adding 763
    adding 183
    adding 544
    adding 651
    adding 951
    adding 438
    adding 505
    adding 309
    adding 800
    adding 534
    adding 864
    adding 930
    adding 36
    not adding 418
    not adding 703
    adding 431
    adding 463
    adding 73
    adding 476
    adding 942
    adding 55
    adding 127
    adding 560
    adding 959
    adding 255
    not adding 176
    adding 969
    adding 35
    not adding 242
    adding 147
    adding 914
    adding 191
    adding 71
    adding 686
    adding 260
    adding 62
    adding 423
    adding 823
    adding 186
    adding 521
    adding 447
    adding 940
    adding 123
    adding 62
    adding 855
    adding 452
    adding 455
    adding 264
    adding 9
    adding 165
    adding 608
    adding 675
    adding 72
    adding 484
    adding 302
    adding 476
    adding 64
    adding 159
    adding 815
    adding 445
    not adding 965
    adding 558
    adding 824
    adding 281
    not adding 98
    Final value: 527144 |}]

(*
--- Part Two ---
The engineer finds the missing part and installs it in the engine! As the engine springs to life, you jump in the closest gondola, finally ready to ascend to the water source.

You don't seem to be going very fast, though. Maybe something is still wrong? Fortunately, the gondola has a phone labeled "help", so you pick it up and the engineer answers.

Before you can explain the situation, she suggests that you look out the window. There stands the engineer, holding a phone in one hand and waving with the other. You're going so slowly that you haven't even left the station. You exit the gondola.

The missing part wasn't the only issue - one of the gears in the engine is wrong. A gear is any * symbol that is adjacent to exactly two part numbers. Its gear ratio is the result of multiplying those two numbers together.

This time, you need to find the gear ratio of every gear and add them all up so that the engineer can figure out which gear needs to be replaced.

Consider the same engine schematic again:

467..114..
...*......
..35..633.
......#...
617*......
.....+.58.
..592.....
......755.
...$.*....
.664.598..
In this schematic, there are two gears. The first is in the top left; it has part numbers 467 and 35, so its gear ratio is 16345. The second gear is in the lower right; its gear ratio is 451490. (The * adjacent to 617 is not a gear because it is only adjacent to one part number.) Adding up all of the gear ratios produces 467835.

What is the sum of all of the gear ratios in your engine schematic?
*)

let is_adjacent_to_symbol ~n ~m ~min_x ~max_x ~y ~is_symbol : bool =
  let exception IsAdjacent in
  try
    for i = Int.max 0 (y - 1) to Int.min (n - 1) (y + 1) do
      for j = Int.max 0 (min_x - 1) to Int.min (m - 1) (max_x + 1) do
        if is_symbol.(i).(j) then raise IsAdjacent
      done
    done;
    false
  with IsAdjacent -> true

let process (schematic : string) =
  let lines = schematic |> String.split_lines |> Array.of_list in
  let n = Array.length lines in
  let m = String.length lines.(0) in
  let gear_nums_mat =
    Array.init n ~f:(fun _ -> Array.init m ~f:(fun _ -> []))
  in
  let add_num value ~min_x ~max_x ~y : unit =
    for i = Int.max 0 (y - 1) to Int.min (n - 1) (y + 1) do
      for j = Int.max 0 (min_x - 1) to Int.min (m - 1) (max_x + 1) do
        if String.get lines.(i) j |> Char.equal '*' then
          gear_nums_mat.(i).(j) <- value :: gear_nums_mat.(i).(j)
      done
    done
  in
  Array.iteri lines ~f:(fun y line ->
      String.foldi line ~init:None ~f:(fun x num char ->
          match num, Int.of_string_opt (String.of_char char) with
          | Some num, Some next_digit ->
            Some {num with value = (num.value * 10) + next_digit}
          | Some {value; min_x}, None ->
            add_num value ~min_x ~max_x:(x - 1) ~y;
            None
          | None, Some value -> Some {value; min_x = x}
          | None, None -> None
      )
      |> function
      | None -> ()
      | Some {value; min_x} -> add_num value ~min_x ~max_x:m ~y
  );
  Array.fold gear_nums_mat ~init:0 ~f:(fun init gear_nums_row ->
      Array.fold gear_nums_row ~init ~f:(fun init gear_nums ->
          match gear_nums with
          | [x; y] -> init + (x * y)
          | _ -> init
      )
  )

let%expect_test _ =
  example_engine_schematic |> process |> printf "%d\n";
  [%expect {| 467835 |}]

let puzzle_input =
  {|.....613...................................439............498.........................438......617....343.............942...................
.......*............790...........269..735..*........................../679..............*444.*.........*.......147...*.............441.....
....539......422.......*......662*........*..691..........*124.15..675.................=.......404...872............237......930.....+......
........334.............861.........%....479..........424.......+.@.......402.......314...905................833........*293................
..........#.......................906.................*...............950.....................712...437.........*142.359........551.14......
....509.....=...........890...................&........9................./..847.154..568............@...102................280...*..........
.....*..950.67.............-......161.......530....=...................=............*...../..............@.......................426........
614...............................*.............59.591.....259*.......342...427..........29../.........-....................946.............
.......896........808..............6.............*.............35............./......538.....572....510...677*380...........=...............
.......*.............*534..814................879...............................615/....*............................90.........580...413...
.......810..........................................714.260..498..........386..........877......754........793...943.*............/.....*...
.....................845..#..483........55...643.......*......&.....421..+.....+...527.....938............*.......*...993...............706.
....339*..370..........-.540.@.....337..........*........39........*........404......&.......*...483...308.....567................../.......
..........*......994..............*......855..356.768.....*.....114...@195..................976....-...............496.61...610...369.200...
..........15........*...@890...447.........*.........*.303......................821..251*....................8........*....+................
...962.............260...................@..716....893..............304............*.....537.........805.....#..........................388.
............201*........................281.............471........*...../.....=....959...............%..238....180..641@...................
....278.........132..........65...&.........*920.......*.......831..97..828.....533......#368............../.......*......66-...............
.....*................*......*..627......343..........111.....*.....................................*.100$........693..........780..........
...974........474..537.759.101.......366....................183...............461*178..850.......644.........57.............................
..........67$.@.........................*...879..................54.100..355.................794.............=.....................826.530..
494*549...............670...=194.....173............329=....*14....*........*....811*303....*....891..541........975........................
........................*................403.............591................667............630....*.....$.667*....#...*......819.........19.
572...@.......%.......271..........910.........578.551..........818.534...........................217.........809.....262.....+.............
.....105.......748..............%........637...*...*........515....*...................119............*143..@.....258.......................
.20........115........714....525...491....*..768...647.....*...................433..../............583.......404..#..............268........
.......650..*.....%......%............*.311............275.283.306..=659.....................499........@................652.176............
..100.....#.193.637..........828...806.............725*........*..............................@......418........370.......@........86&..977.
......350................229..$.............................%...724.....#.981*582..$...............................*.38.....38.503......$...
.......#..380...........*.............311........%..........968......647..........33..................634*13......72./...%...*..*...........
............*.203*52.......+........./...........295.....................888..........277...938..662.........3.........619.320...766........
....149...883..............817...........163............959..........8.....*.811%............*......&...354..+.....392......................
....................727........789......*...............@...............739.........537....326.............*......*.......&925.........938..
..383..505.166......-.........*.......565......491........136.....693..........870.%...........#...........654..&..313.................*....
.........=..$..801....962.....787..........181......186.../..........*103........+............826....599.......289.....311.768..........986.
.292.414..........*......*................*..................214.....................439.@130...........+...52........*.....*.....989*......
.........221......149....405...@...........393..........714.....&.......652............*............607....*.........412....682.......982...
.........*......................491.......................*..............-......906..909.......885.....%.747......19........................
......567.........193........1..................925.........78......117.....797*................@............208............................
.............943..*.....571...*.....919.487............/....+.........*.......................................*......433.922.......795......
....66......*....92..........367.......*....883.625.....479....852@.............277.635............860.......940..21....*....995.....&......
.........206............595%...................*............./.......................*......691.......*..........*..........*...............
.....766.............&................=...........*...649-.241...56..@724..713..836.863.......=....676...+..824.506......247..$132..........
.....................278..........917..864.....219...............+............%.*......................973.........................744......
.........912...............%......*................979....-953...................733.............&................................*.........
.........@........$........995....905......552...................391.........40=.......388.......141...................731*640.....511......
123..662...989.672............................*........611......+.....%910.............*....5......................584......................
...*...*../...........................306.....289.*....*.............................673.....*........970..51....@....*...............#.....
...916.23.......14..828........908.................181.227......26....190.....723..*.......877...513...@...*..977......319..867/...997..76..
..........158........=............$..............................%............#...605....................264.......569.....................1
.....453..*............................815.430*........946..840.........................456.........152................23...................
216.....*.389...........930............*.......211.......-...*.....635..472*185.................................@444...*.....783...966......
...*...72.................*..........527...+...............636.......*.............746....575.....5...276.821........568.+......*...-.......
..765...........991........686..142*......588......@...........366....395.............*..*...............................983...266..........
.................+..................383.............330..&......%...............337.853.337........927.@703.&513......................855...
...652................=../..@.............431....48......512...............541....%.................+.............-...835/.......%......*...
.....*..205.....510.92..901.778............*......./............588.........#..........@....................968.603........820...75....844..
...560............/........................597...................&.......#............698..........427........*...../249....................
..............817..........50..........208..................149..........169........................*......835..............522.............
.....-......................*............*.....470......%..*.......151.................731.......395..979.........200.........#.......$.....
..242.........698........763............531.....*....252...533.....*.........64.........*...233.........*............*262.............498...
........994.....*...............620.639......575................934..606.99....*....770.72.#......@.............................-...........
.......*.........658..355.........#...*............*...*597..............*...645......*........292........-..354...@.......409...515........
........453..594.......#..............571..=552.193...8.............820...69.........877....%..........846.....*...525.446....*........*386.
....&...........#..................................................*....-.................652.................500............361....290.....
...833..................652.....410..924*72..........*.../104.....231.223....@...%....775................375................................
.................470...........*..................663.......................179.10....&.........256..770*............243.........354........
...*5.............*............962......-....................../.....529...................../.....*.........39.255./.......73......&.......
...............253..766....$.............659........$497..241.656....&....630................262.212...154.......*............*.............
...................*....755...................375...........*................@...........................*.....936...159.......786...981....
...................78....................426.....*39....885..835....432..............439.................335............@...................
.......*574.785............................................*................736......*.....860....395...........381...........@..114...825..
....557........@.............187.....640......514.36*.....834.........630...@....*..194......#....-......*......*....164....440.%.....*.....
...................744.908....*........*......*......185......................165........635..........464.354..104.................996......
.........................*.805..604..375...326........................*.................../....970.....................*....................
....751.....776.......661.......*.................777*........434..952.662....2......................$.923...........99.463.........&.514...
....*........*.....55..........414..............................*..............$......&522........378............+............*....89..*....
.331.......403..94..................547.551..............300...600........=......452.......976.+...............213.........815.757..........
.....209-......*...760...............@...*.............................963........+..........*.906.......785...........................+....
958...........319....@.....+.334..........640.................................798.........611......678.....*..630.......389............426..
.........../............961..*..................608..472...........45...........*...................*....390.............*..................
.....597..191......&861.......279.689.............=....*.972*..........560......900.............548..97.......240...51....2....411.......233
......*.......379.................*......+...........770.....989...955...&.214#.........*588.......*.............%..$.......................
....982.&.......................82....850...450......................*...............755.....799....539.....298.........993........788......
.........901....382.......569...............&........428............281.....=599.........98.../....................789.@......956.=....450..
.................*..497/..*...664....*...............%.........610................/944.....*....778......713*375.....*.................*....
.......@......637........443.../...905............................*883.......389...........563......................388...$.....*559....386.
........241.......*597.........................876..............$........731*.....192.483..............#958...%..*......828..100............
...89&.........994.........*228...............#...........18...413..............1....*...........*..........157...453.......................
..........573...........198............447........488.672../.#......&383.........%.....589........511..................46...................
.....*449......$...228*................+.............*........662.........%.............*....321........34%....838&...*.....................
..592.......659...............=...........................................188..248....836......*....................141..%......344.........
............................564....481..............-..........................................861............%...........93.....$...$.936..
..........618.287......490$.......-............*..304.........662.........@....196...@...72*.........918.339.999.-.................28.......
.............*..............................556.......812.272.....235@.510...#.....51.......804...........#.......209......323=.............
.../471..474.................446.......*........855....*....#..............265..................588.24.......522............................
............*........86..755..+........664........*.....311........793.361.....685.......859..../...@..158......=...667#...........871......
...........529.........&.*.........................624........578....*...................*..................334..........843................
....32#........12..818...406......888.........555........678...*...................@....796.%........159.......-.......$.......@142..289....
..........797..@...*..........246....*..........*.............473............485..683.......526.......*................987...........*......
...272....-.......763...........*...............546....203......................%..................560.....294........................921...
......+...............439...144..909....221...............*245.............847....971..........812............*.............................
...........66....+.........*.........20......337.....591.......*.226.&.....*.......-..+113........./........321..756...518....*.............
......325......166..........848................*.267*........857..*..34.....471.............579+.851...322........#...*........125..........
.........*..........157......................77..................567....646...........................*......783....634.5....@..............
.598.497.275.......&......908=............................................$.......172*324...$263.....207......&.........@...340...160....80.
....*..................#........484..833.998....*.....#.......945.135.......108..................104........................................
..............908....645..264*..........*....581.332...519.......*.........*...........811..................214&..$............57...........
....%543.......@..............807..768.......................23............578.........&.....545...................988........*.........#...
...........547..........&.818........*................669....*........395.........88........*.....964*.....................230..105....471..
......................231.&.........645....*982..398...@.....442..........................311.........466....168..788..474......-...........
..233......638.254......................824..........%...........676.....413......818.............................*.......*.................
..............*.........672.137..............866...862...376........*.........933*............455.................158....682..180*333.......
........454$...........*.......................*........#.............................../18.....*.....677...664.........................%867
..............318....107...........*793.....361...............................*................372.......*.....*509......765.203....737.....
.................%........*.216.831....................509.....392............508...........&...........780.........219.....*......&....*635
334............&........862................945.....162*.........*.......529.......164.......627.381*........591........*83...........155....
.......278...476....363....../.........785.%................431...........*..........*529...........194......*..............982*91..........
.......*..................994..480.....*......*.......236...*........825.450......&.......&..797*.......634.249.......................626...
408.699........*527............*....900....145.880...*......833......*...........456....914......432...*...............391..537........*....
.........................836..955.....................126............557.............................870...38..........*.....*.......388....
.................+275.......*..................=................/............526..................................-....66....587............
..........................400....&............933.......*.....535........455*.....&...209.699........90....*10..207...............*.67......
..............757................719.-............*..-...38.....................22.....*..+...254.....$.736..................201.80.+.......
.....86.584............+..*..........531........335.949.......500...........544.....22.11....*......%.........774*434...337...........331...
.183...*............553....691..131..........................*.................*..............186..591..=171............................*...
...*..........645........*.........*.......365............654......*........843..649.............................673.....867........#.218...
....533..206..*...528=...618........891.41*......................988.596........$......%......391..506..672...../...........*103..926.......
............$.49..............*.....................445................@..../......&..678...................61..............................
..63.............998.......927...295..600....303..........352..............358...464......234.......-.......*....517.......-778....32..641..
....*693............*..............*...*...+.../..70......@...417......*.......$.........*..........417...940.....@....................*....
.................529...561.......706...894.740.......117=....+.......251....642...&763..183..................................$..............
544.651.......+........*....951..................438............505..................................309......800..........534..............
...*...........864.....930....*...36*.......418....*...............*................703...............*.........%..431................=.....
...........463................73.....476............942...55.....127..........................560..959................*.............255.....
......%...*.......176..969#...............@35...............*........-.........242...............=.........147.......914....191.............
....71....686................*.................260.........62.423...823..............-.....................*...................=.186........
.................521..447....940...123........*.................+..........62....855..452...............455.......264....9..........*165....
.......$608..675*.....*.../.......*............72......../...........*484....*....=................................*......*.....%...........
...................302..476.......64.....................159......815......445..........965........................558...824....281......98.|}

let%expect_test _ =
  puzzle_input |> process |> printf "%d\n";
  [%expect {| 81463996 |}]
